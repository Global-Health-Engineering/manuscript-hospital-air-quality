---
title: "Manuscript - Malawi Hospital Air Quality Data - Notebook"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


```{r}
library(readr)
library(dplyr)
library(DT)
library(forcats)
library(lubridate)
library(ggplot2)
library(janitor)
library(tidyr)

```

```{r}

dat_in <- read_csv(here::here("data/intermediate/malawi-hospitals-air-quality"))

vec_hospital_id <- dat_in %>% 
  count(id) %>% 
  pull(id)

vec_hospital_name <- dat_in %>% 
  count(location) %>% 
  pull(location)


```

```{r}

# Data transformation

usepa_level_fct <- c("Good", 
                     "Moderate", 
                     "Unhealthy for Sensitive Groups", 
                     "Unhealthy", 
                     "Very Unhealthy", 
                     "Hazardous")

# Data transformation

dat_air_quality <- dat_in %>% 
  mutate(air_quality = case_when(
    indicator == "pm2.5" & value <= 12 ~ "Good",
    indicator == "pm2.5" & value > 12 & indicator == "pm2.5" & value <= 35.4 ~ "Moderate",
    indicator == "pm2.5" & value > 35.4 & indicator == "pm2.5" & value <= 55.4 ~ "Unhealthy for Sensitive Groups",
    indicator == "pm2.5" & value > 55.4 & indicator == "pm2.5" & value <= 150.4 ~ "Unhealthy",
    indicator == "pm2.5" & value > 150.4 & indicator == "pm2.5" & value <= 250.4 ~ "Very Unhealthy",
    indicator == "pm2.5" & value > 250.4 ~ "Hazardous",
    indicator == "pm10" & value <= 54.9 ~ "Good",
    indicator == "pm10" & value > 54.9 & indicator == "pm10" & value <= 154.9 ~ "Moderate",
    indicator == "pm10" & value > 154.9 & indicator == "pm10" & value <= 254.9 ~ "Unhealthy for Sensitive Groups",
    indicator == "pm10" & value > 254.9 & indicator == "pm10" & value <= 354.9 ~ "Unhealthy",
    indicator == "pm10" & value > 354.9 & indicator == "pm10" & value <= 424.9 ~ "Very Unhealthy",
    indicator == "pm10" & value > 424.9 ~ "Hazardous",
  )) %>% 
  mutate(air_quality =
           fct_relevel(air_quality, 
                       levels = usepa_level_fct)) 

# Data transformation - summary statistics

dat_in_sum_day <- dat_in %>% 
  mutate(date = as_date(date_time)) %>% 
  group_by(date, location, indicator) %>% 
  summarise(min = min(value),
            median = median(value),
            mean = mean(value),
            sd = sd(value),
            max = max(value))

dat_in_sum_hour <- dat_in %>% 
  mutate(date = as_date(date_time)) %>% 
  mutate(hour = hour(date_time)) %>% 
  group_by(date, hour, location, indicator) %>% 
  summarise(min = min(value),
            median = median(value),
            mean = mean(value),
            sd = sd(value),
            max = max(value))

# Data transformation - air quality summary

dat_air_quality_sum <- dat_air_quality %>% 
  group_by(location, indicator, air_quality) %>% 
  count(air_quality) %>% 
  mutate(exposure_mins = n * 5) %>% 
  mutate(exposure_hrs = round(exposure_mins / 60)) %>% 
  select(-n)

# data transformation - peaks over twice the limit






```

# Introduction

The purpose of this document is to perform some initial exploratory data analysis for air quality data from Malawi. Based on this analysis, in-depth analysis will be performed and publication ready figures can be produced. 

# Data 

Air quality data (PM2.5 and PM10) was collected in roughly 5-minute intervals from eight locations at one hospital over the period of 3 months. The locations are `r knitr::combine_words(vec_hospital_name)`.

One sensor was installed at each location, either on the side or on the outside wall. 

# Data Exploration

TODO List: 

- 24 hour average (**DONE**)
- baseline (not the two peaks) (**not started**)
- Hourly average (**DONE**)
- Exposure in categories of hazard (**DONE**)
- Peaks over 500 a day (**DONE**)
- Difference between indoor and outdoor sensors (**not started**)
- Ratios PM10 / PM25 (differences by location) (**WIP**)

## Plot: Overview 

```{r plot-overview, fig.cap="Figure caption me!", fig.height=18, fig.width=10}

dat_in %>% 
  ggplot(aes(x = date_time, y = value, color = indicator)) +
  geom_line() +
  #geom_hline(yintercept = 250.5, color = "red") +
  #geom_hline(yintercept = 425.0, color = "red") +
  labs(title = "Hospital Air Quality",
       subtitle = "PM2.5 and PM10  measurements in 5-min intervals at eight locations") +
  theme_bw(base_size = 12) +
  facet_wrap(~location, ncol = 1, scales = "free")
```

## Plot: Daily 24-hour average by date

```{r plot-daily-avg, fig.cap="Figure caption me!", fig.height=18, fig.width=10}

dat_in_sum_day %>% 
  ggplot(aes(x = date, y = mean, group = indicator, color = indicator)) +
  geom_point(size = 0.8) +
  geom_line() +
  labs(title = "Hospital Air Quality",
       subtitle = "Average 24-hour PM2.5 and PM10 concentrations at eight locations") +
  facet_wrap(~location, ncol = 1, scales = "free") +
  theme_bw(base_size = 12) 
#theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


```

## Plot: Daily 24-hour average (rolling)

TODO

```{r}
# TODO
```


## Plot: Hourly average by date and location

```{r plot-hourly-avg, fig.cap="Figure caption me!", fig.height=12, fig.width=10}

for (name in vec_hospital_name) {
  
  hmap_plot <- dat_in_sum_hour %>% 
    filter(location == name) %>% 
    ggplot(aes(x = hour, y = as.factor(date), fill = mean)) +
    geom_tile() +
    labs(title = paste("Hospital Air Quality", "-" , name),
         subtitle = "Hourly average 24-hour PM2.5 and PM10 concentrations",
         y = NULL) +
    scale_fill_viridis_c() +
    scale_x_continuous(breaks = seq(0, 24, 1)) +
    facet_wrap(~indicator) +
    theme_bw(base_size = 12) +
    theme(panel.grid = element_blank())
  
  print(hmap_plot)
}

```


## Plot: Exposure in hours in categories of hazard

```{r, out.width="80%"}

knitr::include_graphics(here::here("img/usepa-air-quality-categories.png"))

```

```{r plot-hazard-expo1, fig.cap="Figure caption me!"}

dat_air_quality_sum %>% 
  ggplot(aes(x = air_quality, y = exposure_hrs)) +
  geom_col() +
  coord_flip() +
  theme_minimal(base_size = 12)

```

```{r plot-hazard-expo2, fig.cap="Figure caption me!", fig.height=12, fig.width=12}

dat_air_quality_sum %>% 
  ggplot(aes(x = air_quality, y = exposure_hrs, fill = location)) +
  geom_col(position = position_dodge()) +
  scale_fill_brewer(type = "qual") + 
  facet_wrap(~location) +
  coord_flip() +
  labs(title = "Air quality at locations at a Hospital Malawi",
       subtitle = "Hours of exposure against PM2.5 and PM10 categorised by USEPA standards",
       y = "Exposure [hours]",
       x = NULL,
       caption = "Data and analysis by @ETH_GHE",
       fill = "Location") +
  theme_minimal(base_size = 12) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank())

```

## Table: Peaks over twice the limit for hazardous

- Peak for PM2.5: 2 x 250.4 = `r 2 * 250.4`
- Peak for PM10: 2 x 424.9 = `r 2 * 424.9`
- Column peaks counts the number of data points above these two limits over all days

```{r}

dat_in %>% 
  mutate(peaks = case_when(
    indicator == "pm2.5" & value > 2 * 250.4 ~ TRUE,
    indicator == "pm10" & value > 2 * 424.9 ~ TRUE,
    TRUE ~ FALSE
  )) %>% 
  mutate(date = as_date(date_time)) %>% 
  group_by(indicator, location) %>% 
  summarise(
    peaks = sum(peaks)
  ) %>% 
  knitr::kable()

```

## Plot: Ratio between PM10 and PM2.5 range from minimum to maximum (WIP)

- Calculation: PM10/PM2.5
- Each line shows the minimum and maximum per day after calculating the average ratio per hour

```{r plot-ratio, fig.cap="Figure caption me!", fig.height=14, fig.width=10}

dat_in %>% 
  mutate(date = as_date(date_time)) %>% 
  mutate(hour = hour(date_time)) %>% 
  group_by(date, hour, location, indicator) %>% 
  summarise(mean = mean(value)) %>% 
  pivot_wider(names_from = indicator, 
              values_from = mean) %>% 

  mutate(p10_pm2.5_ratio = pm10/pm2.5)  %>% 
  group_by(date, location) %>% 
  summarise(min = min(p10_pm2.5_ratio),
            max = max(p10_pm2.5_ratio)) %>% 
  
  ggplot(aes(x = date)) +
  geom_linerange(aes(ymin = min, ymax = max)) +
  facet_wrap(~location, ncol = 2)
  
  
```

